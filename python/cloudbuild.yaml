substitutions:
    _ARTIFACT_REGISTRY_REPO: 'testandbuild'

steps:
    # Install dependencies
    - name: 'Python'
      entrypoint: 'python'
      args: ['-m', 'pip', 'install', '--upgrade', 'pip']
    - name: python
      entrypoint: python
      args: ['-m', 'pip', 'install', 'build', 'pytest', 'Flask', '--user']

    - id: Check Path
      name: 'python'
      entrypoint: sh
      args:
        - -c
        - |
          pwd && ls -la

    # Run unit tests
    - name: python
      entrypoint: python
      args: ["-m", "pytest", "-f", "python/test-app.py", "--junitxml=${SHORT_SHA}_test_log.xml"]

    # Docker Build
    - name: 'gcr.io/cloud-builders/docker'
      args: ['build', '-t',
            'us-central1-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/pyimage:${SHORT_SHA}', '-f', 'python/Dockerfile', '.']

    # Docker push to Google Artifact Registry
    - name: 'gcr.io/cloud-builders/docker'
      args: ['push',  'us-central1-docker.pkg.dev/${PROJECT_ID}/${_ARTIFACT_REGISTRY_REPO}/pyimage:${SHORT_SHA}']

timeout: 10800s
options:
  logging: CLOUD_LOGGING_ONLY
  substitution_option: ALLOW_LOOSE
